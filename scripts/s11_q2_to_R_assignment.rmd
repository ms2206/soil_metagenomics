---
title: "S11_q2_to_R_assignment"
author: "Matthew Spriggs"
date: "2025-01-23"
output: html_document
---


This script imports QIIME 2 artifacts and metadata into R, converts them into a phyloseq object, and performs hierarchical clustering and PERMANOVA analysis. To visualize and statistically analyze the relationships between microbial communities in different sample groups.



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Install packages
Should be done once, so commented
```{r}
# install.packages("devtools")
# devtools::install_github("jbisanz/qiime2R")

# install.packages("BiocManager")

# BiocManager::install("phyloseq")
# BiocManager::install("vegan")

# install.packages("dendextend")
# install.packages("remotes")

# remotes::install_github("jbisanz/qiime2R")
```

# Load packages
I suppressed all messages because some of these libraries are too chatty during loading
```{r}
suppressPackageStartupMessages(suppressWarnings(library(qiime2R))) # for importing QIIME2 artifacts
suppressPackageStartupMessages(suppressWarnings(library(phyloseq))) # for handling phyloseq objects
suppressPackageStartupMessages(suppressWarnings(library(vegan))) # for calculating PERMANOVA using ad
onis2()
suppressPackageStartupMessages(suppressWarnings(library(dendextend))) # for colouring samples dendrogram
```

```{r}
current_dir = dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(current_dir)
setwd('..')
root_dir = getwd()
```

```{r}
data_folder=paste0(root_dir, '/results')
table_qza=file.path(data_folder,"s06b_rarefied_table.qza")
rooted_tree_qza=file.path(data_folder,"s05_rooted_tree.qza")
taxonomy_qza=file.path(data_folder,"s10_taxonomy.qza")

scripts_folder=paste0(root_dir, '/scripts')
tsv_foler=paste0(root_dir, '/data')

metadata_tsv=file.path(tsv_foler,"tabsamplesheet.txt")
```

# Import of QIIME2 artifacts & metadata to R
Import to phyloseq data type using qiime2R package. Then data could be further extracted from the phyloseq object, if necessary.

```{r}
# Convert QIIME2 artifacts & metadata to phyloseq
phy <- qza_to_phyloseq(table_qza, rooted_tree_qza, taxonomy_qza, metadata_tsv)

# Extract metadata and distance matrix from phyloseq object
metadata <- data.frame(sample_data(phy))
distance_matrix <- distance(phy, method="bray")
```

# Samplesâ€™ Hierarchical Clustering & Dendrogram
Formatting the dendrogram with general purpose dendextend R package.

```{r}
bray_clust <- hclust(distance_matrix, method="ward.D2")
bray_dend <- as.dendrogram(bray_clust, hang=0.1)

colour_labels <- c('red','green','blue')[ match(as.factor(metadata$group),
                                                c('frue_ch','mtca_au','ukul_za') ) ]
labels_colors(bray_dend) <- colour_labels

plot(bray_dend, main="Samples dendrogram", ylab="Distances")

legend("topright",
       legend=c('frue_ch','mtca_au','ukul_za'),
       col=c('red','green','blue'),
       bty="n",lty=1, cex=0.8)
```

# PERMANOVA
Using vegan::adonis: the differences between studied groups are highly significant.

```{r}

# Run PERMANOVA
adonis2(distance_matrix ~ group, data = metadata, permutations=100000)

```

# Session info
For reproducible research

```{r}
sessionInfo()
```

